В статье: https://vavilov.elpub.ru/jour/article/view/4187 описана старая версия конвейера. Функционал был значительно расширен и модифицирован.

# Конвейер для обработки гиперспектральных изображений
В данной работе был создан пакет для анализа гиперспектральных изображений, который включает: предварительную обработку, базовый статистический анализ, визуализацию многоканального гиперспектрального изображения, а также решение задач классификации и кластеризации с помощью методов машинного обучения.   
Для использования пакета необходимо клонировать директорию и импортировать пакет.  
![import](https://github.com/igor2704/Hyperspectral_images/blob/main/images/import.png)  

## Обработка и представление гиперспектральных объектов в пакете
### Класс HyperImg
Для описания гиперспектральных изображений необходимо создать или использовать существующий подкласс HyperImg.  
При создании нового проекта необходимо реализовать класс-наследник, переопределить в нем абстрактный метод получения изображения вместе с калибровкой и абстрактный метод получения группы (класса) образца.    
Пример класс-наследника HyperImg:  
![example subclass](https://github.com/igor2704/Hyperspectral_images/blob/main/images/subclass_example.png)  
В данном примере изображения голозерных зерен лежали в директории *голозерные*, а пленчатые — в директории *пленчатые*.  
Также там присутствовали изображения для калибровки, и каждое изображение с их помощью нормализовалось.  
Еще одним примером подкласса HyperImg является TableHyperImg (hyper_img/hyperImg_subclasses/table_hyperImg.py). Описание гиперспектральных изображений в данном классе осуществляется с помощью таблицы. Этот класс использовался для анализа, описанного в статье.  

### Класс Segmenter
Для анализа гиперспектра изучаемого объекта необходимо выделить область гиперспектрального изображения, где этот объект находится. 
Для выполнения этапа сегментации необходимо создать подкласс абстрактного класса Segmenter и реализовать метод, который на вход принимает гиперспектральное изображение и возвращает бинарную маску.  
Примерами подклассов Segmenter являются PlainCv2Segmenter (hyper_img/hyperImg_segmenter/segmenter_subclasses/plain_cv2_segmenter.py) и CircleCv2Segmenter (hyper_img/hyperImg_segmenter/segmenter_subclasses/cv2_circle_segmenter.py). PlainCv2Segmenter осуществляет сегментацию по пороговому преобразованию черно-белого изображения. CircleCv2Segmenter предполагает, что объект имеет форму круга (например, чашка Петри). CircleCv2Segmenter с помощью порогового преобразования вычисляет центр круга и его радиус, а далее, чтобы избежать краевых эффектов, сегментирует область, имеющую форму круга с вычисленным центром, но меньшего радиуса.   

### Класс HyperData
Абстрактный класс HyperData принимает на вход реализованный подкласс HyperImg и подкласс Segmenter, а также путь к гиперспектральным изображениям и набор исследуемых факторов (например, мутация зерен и серия съемки). Этот класс содержит информацию о множестве гиперспектральных изображений, а также представление этих изображений. Все реализованные в пакете функции работают с объектом этого класса. Необходимо создать подкласс этого класса, реализовав метод извлечения признаков из гиперспектрального изображения. Эти признаки будут отождествляться с гиперспектральным изображением.  
HyperDataPixels (hyper_img/hyperImg_data_classes/data_subclasses/pixels.py) и HyperDataMedian (hyper_img/hyperImg_data_classes/data_subclasses/median.py) — это реализованные на данный момент подклассы HyperData. HyperDataMedian отождествляет каждое гиперспектральное изображение с вектором медиан каждого канала. HyperDataPixels отождествляет с набором пикселей (или бакетов).  
![HyperData](https://github.com/igor2704/Hyperspectral_images/blob/main/images/hyper_data.png) 

## Визуализация, статистический анализ и кластеризация
Получение результатов анализа реализовано в файле: hyper_img/hyperImg_functions/get_graphics_funcs.py  
Визуализация результатов также реализована в файле: hyper_img/hyperImg_functions/get_graphics_funcs.py  
Для выполнения этого этапа можно воспользоваться функцией create_folder_with_all_graphs из hyper_img/hyperImg_functions/get_graphics_funcs.py  

### Визуализация
Визуализация выполнена с помощью библиотеки Plotly. Для визуализации в двумерное пространство использовались следующие методы понижения размерности: PCA (get_2_pca_graph), ISOMAP (get_2_isomap_graph), UMAP (get_2_umap_graph). Также для визуальной оценки распределений строились диаграммы размаха (get_boxplot_graphs).  

### Статистический анализ
Статистический анализ включает в себя критерий Фишера (get_anova_graph), критерий Тьюки (get_tukey_pairwise_graph), критерий Манна-Уитни (get_mannwhitneyu_pairwise_graph), критерий Стьюдента (get_ttest_pairwise_graph). Для корректной поправки на множественное тестирование и контроля FWER (или FDR) рекомендуется использовать функцию get_stat_tests_graph.  

### Кластеризация
Кластеризация выполнена с помощью EM-алгоритма (get_em_algorithm_clustering_graph).  

## Классификация с помощью методов машинного обучения
В пакете реализована классификация по фактору (hyper_img/hyperImg_functions/machine_learning_funcs.py).  
Для классификации использовались следующие методы машинного обучения: логистическая регрессия, гребневая регрессия, случайный лес и градиентный бустинг (CatBoost).   
Для выполнения этого этапа следует воспользоваться функцией get_table_res_and_confusion_matrix, в результате она выдаст таблицу с метриками (микро-/макро-) и матрицу ошибок.  

### 
В директории examples находятся Jupyter Notebook с примерами использования конвейера.  
E-mail для связи: *i.busov@g.nsu.ru*"

